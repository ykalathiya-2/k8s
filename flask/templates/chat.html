{% extends "base.html" %}

{% block title %}Chat - Chat App{% endblock %}

{% block styles %}
.chat-container {
    display: grid;
    grid-template-columns: 250px 1fr 250px;
    gap: 1rem;
    height: calc(100vh - 120px);
}

.sidebar {
    background: var(--white);
    border-radius: 8px;
    padding: 1rem;
    overflow-y: auto;
    box-shadow: 0 2px 8px var(--shadow);
}

.sidebar h3 {
    margin-bottom: 1rem;
    font-size: 1.1rem;
}

.room-list, .user-list {
    list-style: none;
}

.room-item, .user-item {
    padding: 0.75rem;
    margin-bottom: 0.5rem;
    border-radius: 6px;
    cursor: pointer;
    transition: background 0.2s;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.room-item:hover, .user-item:hover {
    background: var(--light);
}

.room-item.active {
    background: var(--primary);
    color: var(--white);
}

.chat-main {
    display: flex;
    flex-direction: column;
    background: var(--white);
    border-radius: 8px;
    box-shadow: 0 2px 8px var(--shadow);
}

.chat-header {
    padding: 1rem;
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 1rem;
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.message {
    display: flex;
    gap: 0.75rem;
    max-width: 70%;
}

.message.own {
    align-self: flex-end;
    flex-direction: row-reverse;
}

.message-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
}

.message-content {
    flex: 1;
}

.message-header {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 0.25rem;
    font-size: 0.875rem;
}

.message-author {
    font-weight: 600;
}

.message-time {
    color: var(--secondary);
}

.message-text {
    background: var(--light);
    padding: 0.75rem;
    border-radius: 8px;
    word-wrap: break-word;
}

.message.own .message-text {
    background: #e3f2ff;
}

.message-image {
    max-width: 100%;
    border-radius: 8px;
    margin-top: 0.5rem;
}

.chat-input {
    padding: 1rem;
    border-top: 1px solid var(--border);
    display: flex;
    gap: 0.5rem;
}

.chat-input input {
    flex: 1;
}

.typing-indicator {
    padding: 0.5rem 1rem;
    color: var(--secondary);
    font-style: italic;
    font-size: 0.875rem;
}

.online-indicator {
    width: 8px;
    height: 8px;
    background: var(--success);
    border-radius: 50%;
}

.offline-indicator {
    width: 8px;
    height: 8px;
    background: var(--secondary);
    border-radius: 50%;
}

.create-room-btn {
    width: 100%;
    margin-bottom: 1rem;
}

.file-upload-btn {
    padding: 0.5rem 1rem;
    background: var(--secondary);
    color: white;
    border-radius: 4px;
    cursor: pointer;
}

.file-upload-btn:hover {
    background: #5a6268;
}

.system-message {
    text-align: center;
    color: var(--secondary);
    font-style: italic;
    font-size: 0.875rem;
    margin: 0.5rem 0;
}

@media (max-width: 768px) {
    .chat-container {
        grid-template-columns: 1fr;
    }
    
    .sidebar:last-child {
        display: none;
    }
}
{% endblock %}

{% block content %}
<div class="chat-container">
    <!-- Left Sidebar - Rooms -->
    <div class="sidebar">
        <h3>üè† Rooms</h3>
        <button class="btn btn-primary btn-sm create-room-btn" onclick="createRoom()">+ New Room</button>
        <ul class="room-list" id="roomList">
            {% for room in rooms %}
            <li class="room-item" data-room-id="{{ room.id }}" onclick="joinRoom({{ room.id }}, '{{ room.name }}')">
                <span>{{ 'üîí' if room.is_private else '#' }}</span>
                <span>{{ room.name }}</span>
            </li>
            {% endfor %}
        </ul>
    </div>
    
    <!-- Main Chat Area -->
    <div class="chat-main">
        <div class="chat-header">
            <div>
                <h3 id="currentRoomName">Select a room to start chatting</h3>
                <p id="roomDescription" style="font-size: 0.875rem; color: var(--secondary);"></p>
            </div>
            <div id="roomActions"></div>
        </div>
        
        <div class="chat-messages" id="messages">
            <div class="system-message">üëã Welcome to the chat! Select a room to start.</div>
        </div>
        
        <div class="typing-indicator" id="typingIndicator"></div>
        
        <div class="chat-input">
            <label for="fileInput" class="file-upload-btn">üìé</label>
            <input type="file" id="fileInput" style="display: none;" accept="image/*">
            <input type="text" class="form-control" id="messageInput" placeholder="Type a message..." disabled>
            <button class="btn btn-primary" id="sendBtn" disabled>Send</button>
        </div>
    </div>
    
    <!-- Right Sidebar - Online Users -->
    <div class="sidebar">
        <h3>üë• Online Users</h3>
        <ul class="user-list" id="onlineUsers">
            <li class="system-message">No users online</li>
        </ul>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
<script>
    const socket = io();
    let currentRoomId = null;
    let typingTimeout = null;
    
    const userId = {{ user.id }};
    const username = "{{ user.username }}";
    
    // DOM Elements
    const messagesEl = document.getElementById('messages');
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const fileInput = document.getElementById('fileInput');
    const typingIndicator = document.getElementById('typingIndicator');
    const currentRoomNameEl = document.getElementById('currentRoomName');
    const roomDescriptionEl = document.getElementById('roomDescription');
    const onlineUsersEl = document.getElementById('onlineUsers');
    
    // Socket Event Handlers
    socket.on('connect', () => {
        console.log('Connected to server');
    });
    
    socket.on('new_message', (message) => {
        addMessage(message);
    });
    
    socket.on('user_joined', (data) => {
        addSystemMessage(`${data.username} joined the room`);
        updateOnlineUsers();
    });
    
    socket.on('user_left', (data) => {
        addSystemMessage(`${data.username} left the room`);
        updateOnlineUsers();
    });
    
    socket.on('user_typing', (data) => {
        if (data.user_id !== userId && data.is_typing) {
            typingIndicator.textContent = `${data.username} is typing...`;
        } else {
            typingIndicator.textContent = '';
        }
    });
    
    socket.on('online_users', (data) => {
        displayOnlineUsers(data.users);
    });
    
    // Join Room Function
    function joinRoom(roomId, roomName) {
        if (currentRoomId) {
            socket.emit('leave', { room_id: currentRoomId });
        }
        
        currentRoomId = roomId;
        currentRoomNameEl.textContent = roomName;
        messagesEl.innerHTML = '';
        
        socket.emit('join', { room_id: roomId });
        
        // Enable input
        messageInput.disabled = false;
        sendBtn.disabled = false;
        messageInput.focus();
        
        // Update active room styling
        document.querySelectorAll('.room-item').forEach(item => {
            item.classList.remove('active');
        });
        document.querySelector(`[data-room-id="${roomId}"]`)?.classList.add('active');
        
        // Load message history
        loadMessages(roomId);
    }
    
    // Load Messages
    async function loadMessages(roomId) {
        try {
            const response = await fetch(`/api/rooms/${roomId}/messages`);
            const messages = await response.json();
            messages.forEach(msg => addMessage(msg));
        } catch (error) {
            console.error('Error loading messages:', error);
        }
    }
    
    // Add Message to UI
    function addMessage(message) {
        const isOwn = message.user_id === userId;
        const time = new Date(message.timestamp).toLocaleTimeString();
        
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${isOwn ? 'own' : ''}`;
        
        const avatarColor = `hsl(${(message.user_id * 137) % 360} 70% 45%)`;
        
        messageDiv.innerHTML = `
            <div class="message-avatar" style="background: ${avatarColor}">
                ${message.username.substring(0, 2).toUpperCase()}
            </div>
            <div class="message-content">
                <div class="message-header">
                    <span class="message-author">${message.username}</span>
                    <span class="message-time">${time}</span>
                </div>
                <div class="message-text">
                    ${message.content}
                    ${message.is_file ? `<br><img src="${message.file_url}" class="message-image" alt="Uploaded image">` : ''}
                </div>
            </div>
        `;
        
        messagesEl.appendChild(messageDiv);
        messagesEl.scrollTop = messagesEl.scrollHeight;
    }
    
    // Add System Message
    function addSystemMessage(text) {
        const div = document.createElement('div');
        div.className = 'system-message';
        div.textContent = text;
        messagesEl.appendChild(div);
        messagesEl.scrollTop = messagesEl.scrollHeight;
    }
    
    // Send Message
    function sendMessage() {
        const content = messageInput.value.trim();
        if (!content || !currentRoomId) return;
        
        socket.emit('message', {
            room_id: currentRoomId,
            content: content
        });
        
        messageInput.value = '';
        messageInput.focus();
    }
    
    // Typing Indicator
    messageInput.addEventListener('input', () => {
        if (!currentRoomId) return;
        
        socket.emit('typing', { room_id: currentRoomId, is_typing: true });
        
        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => {
            socket.emit('typing', { room_id: currentRoomId, is_typing: false });
        }, 1000);
    });
    
    // Send Button Click
    sendBtn.addEventListener('click', sendMessage);
    
    // Enter Key to Send
    messageInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });
    
    // File Upload
    fileInput.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file || !currentRoomId) return;
        
        const formData = new FormData();
        formData.append('file', file);
        formData.append('room_id', currentRoomId);
        
        try {
            const response = await fetch('/upload', {
                method: 'POST',
                body: formData
            });
            
            if (response.ok) {
                console.log('File uploaded successfully');
            }
        } catch (error) {
            console.error('Error uploading file:', error);
            alert('Error uploading file');
        }
        
        fileInput.value = '';
    });
    
    // Create New Room
    async function createRoom() {
        const name = prompt('Enter room name:');
        if (!name) return;
        
        const description = prompt('Enter room description (optional):') || '';
        const isPrivate = confirm('Make this room private?');
        
        try {
            const response = await fetch('/api/rooms', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    name: name,
                    description: description,
                    is_private: isPrivate
                })
            });
            
            if (response.ok) {
                const room = await response.json();
                location.reload();
            } else {
                const error = await response.json();
                alert(error.error || 'Error creating room');
            }
        } catch (error) {
            console.error('Error creating room:', error);
            alert('Error creating room');
        }
    }
    
    // Update Online Users
    async function updateOnlineUsers() {
        socket.emit('get_online_users', { room_id: currentRoomId });
    }
    
    // Display Online Users
    function displayOnlineUsers(users) {
        if (!users || users.length === 0) {
            onlineUsersEl.innerHTML = '<li class="system-message">No users online</li>';
            return;
        }
        
        onlineUsersEl.innerHTML = users.map(user => {
            const avatarColor = `hsl(${(user.id * 137) % 360} 70% 45%)`;
            return `
                <li class="user-item">
                    <div class="online-indicator"></div>
                    <div class="user-avatar" style="background: ${avatarColor}; width: 32px; height: 32px; font-size: 0.875rem;">
                        ${user.username.substring(0, 2).toUpperCase()}
                    </div>
                    <span>${user.username}</span>
                </li>
            `;
        }).join('');
    }
    
    // Auto-join first room if available
    {% if rooms %}
    setTimeout(() => {
        joinRoom({{ rooms[0].id }}, "{{ rooms[0].name }}");
    }, 500);
    {% endif %}
</script>
{% endblock %}
