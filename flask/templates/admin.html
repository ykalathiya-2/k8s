{% extends "base.html" %}

{% block title %}Admin Panel - Chat App{% endblock %}

{% block styles %}
.admin-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}

.stat-card {
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    color: white;
    padding: 1.5rem;
    border-radius: 8px;
    text-align: center;
}

.stat-number {
    font-size: 2.5rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
}

.stat-label {
    font-size: 0.875rem;
    opacity: 0.9;
}

.data-table {
    width: 100%;
    border-collapse: collapse;
}

.data-table th,
.data-table td {
    padding: 0.75rem;
    text-align: left;
    border-bottom: 1px solid var(--border);
}

.data-table th {
    background: var(--light);
    font-weight: 600;
}

.data-table tr:hover {
    background: var(--light);
}

.badge {
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 600;
}

.badge-success {
    background: var(--success);
    color: white;
}

.badge-secondary {
    background: var(--secondary);
    color: white;
}

.badge-danger {
    background: var(--danger);
    color: white;
}

.tab-buttons {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1rem;
}

.tab-button {
    padding: 0.75rem 1.5rem;
    border: none;
    background: var(--light);
    cursor: pointer;
    border-radius: 6px;
    transition: all 0.3s;
}

.tab-button.active {
    background: var(--primary);
    color: white;
}

.tab-content {
    display: none;
}

.tab-content.active {
    display: block;
}
{% endblock %}

{% block content %}
<div class="card">
    <h2 style="margin-bottom: 1.5rem;">üõ†Ô∏è Admin Dashboard</h2>
    
    <div class="admin-grid">
        <div class="stat-card">
            <div class="stat-number">{{ stats.total_users }}</div>
            <div class="stat-label">Total Users</div>
        </div>
        <div class="stat-card" style="background: linear-gradient(135deg, var(--success), #1e7e34);">
            <div class="stat-number">{{ stats.total_rooms }}</div>
            <div class="stat-label">Total Rooms</div>
        </div>
        <div class="stat-card" style="background: linear-gradient(135deg, var(--info), #117a8b);">
            <div class="stat-number">{{ stats.total_messages }}</div>
            <div class="stat-label">Total Messages</div>
        </div>
        <div class="stat-card" style="background: linear-gradient(135deg, var(--warning), #d39e00);">
            <div class="stat-number">{{ stats.online_users }}</div>
            <div class="stat-label">Online Users</div>
        </div>
    </div>
    
    <div class="tab-buttons">
        <button class="tab-button active" onclick="showTab('users')">Users</button>
        <button class="tab-button" onclick="showTab('rooms')">Rooms</button>
        <button class="tab-button" onclick="showTab('messages')">Recent Messages</button>
    </div>
    
    <!-- Users Tab -->
    <div id="users-tab" class="tab-content active">
        <h3 style="margin-bottom: 1rem;">User Management</h3>
        <table class="data-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Username</th>
                    <th>Email</th>
                    <th>Role</th>
                    <th>Joined</th>
                    <th>Last Seen</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for u in users %}
                <tr>
                    <td>{{ u.id }}</td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <div class="user-avatar" style="width: 30px; height: 30px; font-size: 0.75rem; background: hsl({{ u.id * 137 % 360 }} 70% 45%)">
                                {{ u.username[:2].upper() }}
                            </div>
                            {{ u.username }}
                        </div>
                    </td>
                    <td>{{ u.email }}</td>
                    <td>
                        {% if u.is_admin %}
                            <span class="badge badge-danger">Admin</span>
                        {% else %}
                            <span class="badge badge-secondary">User</span>
                        {% endif %}
                    </td>
                    <td>{{ u.created_at.strftime('%Y-%m-%d') }}</td>
                    <td>{{ u.last_seen.strftime('%Y-%m-%d %H:%M') }}</td>
                    <td>
                        <button class="btn btn-sm btn-secondary" onclick="viewUser({{ u.id }})">View</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <!-- Rooms Tab -->
    <div id="rooms-tab" class="tab-content">
        <h3 style="margin-bottom: 1rem;">Room Management</h3>
        <table class="data-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Description</th>
                    <th>Type</th>
                    <th>Messages</th>
                    <th>Created</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for room in rooms %}
                <tr>
                    <td>{{ room.id }}</td>
                    <td>{{ 'üîí' if room.is_private else '#' }} {{ room.name }}</td>
                    <td>{{ room.description[:50] }}{% if room.description|length > 50 %}...{% endif %}</td>
                    <td>
                        {% if room.is_private %}
                            <span class="badge badge-danger">Private</span>
                        {% else %}
                            <span class="badge badge-success">Public</span>
                        {% endif %}
                    </td>
                    <td>{{ room.messages|length }}</td>
                    <td>{{ room.created_at.strftime('%Y-%m-%d') }}</td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="deleteRoom({{ room.id }})">Delete</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <!-- Messages Tab -->
    <div id="messages-tab" class="tab-content">
        <h3 style="margin-bottom: 1rem;">Recent Messages</h3>
        <table class="data-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>User</th>
                    <th>Room</th>
                    <th>Content</th>
                    <th>Timestamp</th>
                    <th>Type</th>
                </tr>
            </thead>
            <tbody>
                {% for msg in messages %}
                <tr>
                    <td>{{ msg.id }}</td>
                    <td>{{ msg.author.username }}</td>
                    <td>{{ msg.room.name }}</td>
                    <td>{{ msg.content[:50] }}{% if msg.content|length > 50 %}...{% endif %}</td>
                    <td>{{ msg.timestamp.strftime('%Y-%m-%d %H:%M') }}</td>
                    <td>
                        {% if msg.is_file %}
                            <span class="badge badge-secondary">File</span>
                        {% else %}
                            <span class="badge badge-success">Text</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
    function showTab(tabName) {
        // Hide all tabs
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.remove('active');
        });
        
        // Deactivate all buttons
        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.classList.remove('active');
        });
        
        // Show selected tab
        document.getElementById(`${tabName}-tab`).classList.add('active');
        
        // Activate selected button
        event.target.classList.add('active');
    }
    
    function viewUser(userId) {
        window.location.href = `/api/users/${userId}`;
    }
    
    async function deleteRoom(roomId) {
        if (!confirm('Are you sure you want to delete this room? All messages will be lost.')) {
            return;
        }
        
        try {
            const response = await fetch(`/api/rooms/${roomId}`, {
                method: 'DELETE'
            });
            
            if (response.ok) {
                alert('Room deleted successfully');
                location.reload();
            } else {
                alert('Error deleting room');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error deleting room');
        }
    }
</script>
{% endblock %}
