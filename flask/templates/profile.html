{% extends "base.html" %}

{% block title %}Profile - Chat App{% endblock %}

{% block content %}
<div style="max-width: 600px; margin: 2rem auto;">
    <div class="card">
        <h2 style="margin-bottom: 1.5rem;">Your Profile</h2>
        
        <div style="text-align: center; margin-bottom: 2rem;">
            <div class="user-avatar" style="width: 100px; height: 100px; font-size: 2.5rem; margin: 0 auto; background: hsl({{ user.id * 137 % 360 }} 70% 45%)">
                {{ user.username[:2].upper() }}
            </div>
            <h3 style="margin-top: 1rem;">{{ user.username }}</h3>
            {% if user.is_admin %}
                <span style="background: var(--warning); color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.875rem;">Admin</span>
            {% endif %}
        </div>
        
        <form id="profileForm">
            <div class="form-group">
                <label class="form-label">Username</label>
                <input type="text" class="form-control" value="{{ user.username }}" disabled>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="email">Email</label>
                <input type="email" class="form-control" id="email" name="email" value="{{ user.email }}">
            </div>
            
            <div class="form-group">
                <label class="form-label" for="avatar">Avatar Image</label>
                <input type="file" class="form-control" id="avatar" name="avatar" accept="image/*">
            </div>
            
            <div class="form-group">
                <label class="form-label">Member Since</label>
                <input type="text" class="form-control" value="{{ user.created_at.strftime('%B %d, %Y') }}" disabled>
            </div>
            
            <div class="form-group">
                <label class="form-label">Last Seen</label>
                <input type="text" class="form-control" value="{{ user.last_seen.strftime('%B %d, %Y %I:%M %p') }}" disabled>
            </div>
            
            <button type="submit" class="btn btn-primary">Update Profile</button>
        </form>
        
        <div id="updateMessage" style="margin-top: 1rem;"></div>
    </div>
    
    <div class="card" style="margin-top: 1rem;">
        <h3 style="margin-bottom: 1rem;">Statistics</h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div style="text-align: center; padding: 1rem; background: var(--light); border-radius: 6px;">
                <div style="font-size: 2rem; font-weight: 600; color: var(--primary);">{{ user.messages|length }}</div>
                <div style="color: var(--secondary);">Messages Sent</div>
            </div>
            <div style="text-align: center; padding: 1rem; background: var(--light); border-radius: 6px;">
                <div style="font-size: 2rem; font-weight: 600; color: var(--success);">{{ user.created_rooms|length }}</div>
                <div style="color: var(--secondary);">Rooms Created</div>
            </div>
        </div>
    </div>
</div>

<script>
    document.getElementById('profileForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const formData = new FormData();
        const email = document.getElementById('email').value;
        const avatarFile = document.getElementById('avatar').files[0];
        
        formData.append('email', email);
        if (avatarFile) {
            formData.append('avatar', avatarFile);
        }
        
        try {
            const response = await fetch('/profile/update', {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            const messageEl = document.getElementById('updateMessage');
            
            if (result.success) {
                messageEl.innerHTML = '<div class="alert alert-success">Profile updated successfully!</div>';
                setTimeout(() => location.reload(), 1500);
            } else {
                messageEl.innerHTML = `<div class="alert alert-danger">${result.error}</div>`;
            }
        } catch (error) {
            console.error('Error updating profile:', error);
            document.getElementById('updateMessage').innerHTML = '<div class="alert alert-danger">Error updating profile</div>';
        }
    });
</script>
{% endblock %}
